<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard K-mita</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-item {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #ccc;
        }
        .test-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .test-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .test-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #console {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Dashboard K-mita</h1>
        <p>Verificaci√≥n r√°pida de funcionalidades implementadas</p>
        
        <div class="test-section">
            <h3>üîß Tests de Configuraci√≥n</h3>
            <div id="configTests"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä Tests de Funciones</h3>
            <div id="functionTests"></div>
        </div>
        
        <div class="test-section">
            <h3>üéÆ Acciones</h3>
            <button onclick="runAllTests()">üß™ Ejecutar Todos los Tests</button>
            <button onclick="openDashboard()">üöÄ Abrir Dashboard Principal</button>
            <button onclick="clearConsole()">üóëÔ∏è Limpiar Consola</button>
        </div>
        
        <div id="console">Haz clic en "Ejecutar Todos los Tests" para comenzar...</div>
    </div>

    <script>
        let consoleElement;
        
        document.addEventListener('DOMContentLoaded', function() {
            consoleElement = document.getElementById('console');
            log('üöÄ Test Dashboard K-mita inicializado');
            log('üìã Listo para ejecutar verificaciones');
        });

        function log(message) {
            if (consoleElement) {
                const timestamp = new Date().toLocaleTimeString('es-MX');
                consoleElement.textContent += `[${timestamp}] ${message}\n`;
                consoleElement.scrollTop = consoleElement.scrollHeight;
            }
        }

        function addTestResult(containerId, testName, status, message) {
            const container = document.getElementById(containerId);
            const testItem = document.createElement('div');
            testItem.className = `test-item test-${status}`;
            
            const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚ö†Ô∏è';
            testItem.innerHTML = `${icon} <strong>${testName}:</strong> ${message}`;
            
            container.appendChild(testItem);
        }

        async function runAllTests() {
            log('üß™ Iniciando tests completos...');
            
            // Limpiar resultados anteriores
            document.getElementById('configTests').innerHTML = '';
            document.getElementById('functionTests').innerHTML = '';
            
            // Tests de configuraci√≥n
            await testConfiguration();
            
            // Tests de funciones
            await testFunctions();
            
            log('‚úÖ Tests completados');
        }

        async function testConfiguration() {
            log('üîß Ejecutando tests de configuraci√≥n...');
            
            // Test 1: Verificar archivos principales
            try {
                const response = await fetch('config.js');
                if (response.ok) {
                    addTestResult('configTests', 'Config.js', 'success', 'Archivo encontrado y accesible');
                    log('‚úÖ config.js - OK');
                } else {
                    addTestResult('configTests', 'Config.js', 'error', 'Archivo no encontrado');
                    log('‚ùå config.js - ERROR');
                }
            } catch (error) {
                addTestResult('configTests', 'Config.js', 'error', 'Error al cargar: ' + error.message);
                log('‚ùå config.js - ERROR: ' + error.message);
            }

            // Test 2: Verificar script principal
            try {
                const response = await fetch('shopify-analytics-script.js');
                if (response.ok) {
                    addTestResult('configTests', 'Script Principal', 'success', 'Archivo encontrado y accesible');
                    log('‚úÖ shopify-analytics-script.js - OK');
                } else {
                    addTestResult('configTests', 'Script Principal', 'error', 'Archivo no encontrado');
                    log('‚ùå shopify-analytics-script.js - ERROR');
                }
            } catch (error) {
                addTestResult('configTests', 'Script Principal', 'error', 'Error al cargar: ' + error.message);
                log('‚ùå shopify-analytics-script.js - ERROR: ' + error.message);
            }

            // Test 3: Verificar estilos
            try {
                const response = await fetch('shopify-analytics-styles.css');
                if (response.ok) {
                    addTestResult('configTests', 'Estilos CSS', 'success', 'Archivo encontrado y accesible');
                    log('‚úÖ shopify-analytics-styles.css - OK');
                } else {
                    addTestResult('configTests', 'Estilos CSS', 'error', 'Archivo no encontrado');
                    log('‚ùå shopify-analytics-styles.css - ERROR');
                }
            } catch (error) {
                addTestResult('configTests', 'Estilos CSS', 'error', 'Error al cargar: ' + error.message);
                log('‚ùå shopify-analytics-styles.css - ERROR: ' + error.message);
            }
        }

        async function testFunctions() {
            log('üìä Ejecutando tests de funciones...');
            
            // Test de datos de ejemplo para verificar funciones
            const testOrdersData = [
                {
                    order_number: '5454',
                    customer_email: 'test@example.com',
                    total_price: '995',
                    total_kilos: '30',
                    created_at: '2025-01-31T13:39:11-06:00',
                    processed_at: '2025-01-31T13:39:11-06:00',
                    shipping_province: 'Quer√©taro',
                    shipping_city: 'Quer√©taro',
                    payment_method: 'Tarjeta de Cr√©dito',
                    accepts_marketing: true
                },
                {
                    order_number: '5453',
                    customer_email: 'test2@example.com',
                    total_price: '319',
                    total_kilos: '6',
                    created_at: '2025-01-30T19:13:41-06:00',
                    processed_at: '2025-01-30T19:13:41-06:00',
                    shipping_province: 'CDMX',
                    shipping_city: 'Ciudad de M√©xico',
                    payment_method: 'PayPal',
                    accepts_marketing: false
                }
            ];

            // Test 1: Funci√≥n calculateUniqueCustomers
            try {
                const uniqueCustomers = calculateUniqueCustomersTest(testOrdersData);
                if (uniqueCustomers === 2) {
                    addTestResult('functionTests', 'Clientes √önicos', 'success', `Calculado correctamente: ${uniqueCustomers}`);
                    log('‚úÖ calculateUniqueCustomers - OK: ' + uniqueCustomers);
                } else {
                    addTestResult('functionTests', 'Clientes √önicos', 'error', `Resultado incorrecto: ${uniqueCustomers}`);
                    log('‚ùå calculateUniqueCustomers - ERROR: ' + uniqueCustomers);
                }
            } catch (error) {
                addTestResult('functionTests', 'Clientes √önicos', 'error', 'Error en funci√≥n: ' + error.message);
                log('‚ùå calculateUniqueCustomers - ERROR: ' + error.message);
            }

            // Test 2: Funci√≥n calculateAvgPricePerKilo
            try {
                const avgPrice = calculateAvgPricePerKiloTest(testOrdersData);
                const expected = (995 + 319) / (30 + 6); // 36.5
                if (Math.abs(avgPrice - expected) < 0.1) {
                    addTestResult('functionTests', 'Precio Promedio/Kg', 'success', `Calculado correctamente: $${avgPrice.toFixed(2)}`);
                    log('‚úÖ calculateAvgPricePerKilo - OK: ' + avgPrice.toFixed(2));
                } else {
                    addTestResult('functionTests', 'Precio Promedio/Kg', 'error', `Resultado incorrecto: ${avgPrice}`);
                    log('‚ùå calculateAvgPricePerKilo - ERROR: ' + avgPrice);
                }
            } catch (error) {
                addTestResult('functionTests', 'Precio Promedio/Kg', 'error', 'Error en funci√≥n: ' + error.message);
                log('‚ùå calculateAvgPricePerKilo - ERROR: ' + error.message);
            }

            // Test 3: Funci√≥n calculateAvgFulfillmentDays
            try {
                const avgDays = calculateAvgFulfillmentDaysTest(testOrdersData);
                if (avgDays >= 0) {
                    addTestResult('functionTests', 'D√≠as Fulfillment', 'success', `Calculado correctamente: ${avgDays.toFixed(1)} d√≠as`);
                    log('‚úÖ calculateAvgFulfillmentDays - OK: ' + avgDays.toFixed(1));
                } else {
                    addTestResult('functionTests', 'D√≠as Fulfillment', 'error', `Resultado incorrecto: ${avgDays}`);
                    log('‚ùå calculateAvgFulfillmentDays - ERROR: ' + avgDays);
                }
            } catch (error) {
                addTestResult('functionTests', 'D√≠as Fulfillment', 'error', 'Error en funci√≥n: ' + error.message);
                log('‚ùå calculateAvgFulfillmentDays - ERROR: ' + error.message);
            }

            // Test 4: Verificar que Chart.js est√© disponible
            if (typeof Chart !== 'undefined') {
                addTestResult('functionTests', 'Chart.js', 'success', 'Librer√≠a cargada correctamente');
                log('‚úÖ Chart.js - OK');
            } else {
                addTestResult('functionTests', 'Chart.js', 'error', 'Librer√≠a no encontrada');
                log('‚ùå Chart.js - ERROR');
            }
        }

        // Funciones de test simplificadas
        function calculateUniqueCustomersTest(ordersData) {
            const uniqueEmails = new Set();
            ordersData.forEach(order => {
                if (order.customer_email && order.customer_email.trim() !== '') {
                    uniqueEmails.add(order.customer_email.toLowerCase());
                }
            });
            return uniqueEmails.size;
        }

        function calculateAvgPricePerKiloTest(ordersData) {
            let totalRevenue = 0;
            let totalKilos = 0;
            
            ordersData.forEach(order => {
                const price = parseFloat(order.total_price || 0);
                const kilos = parseFloat(order.total_kilos || 0);
                
                if (price > 0 && kilos > 0) {
                    totalRevenue += price;
                    totalKilos += kilos;
                }
            });
            
            return totalKilos > 0 ? totalRevenue / totalKilos : 0;
        }

        function calculateAvgFulfillmentDaysTest(ordersData) {
            const fulfillmentDays = [];
            
            ordersData.forEach(order => {
                const createdDate = new Date(order.created_at);
                const processedDate = new Date(order.processed_at);
                
                if (!isNaN(createdDate.getTime()) && !isNaN(processedDate.getTime())) {
                    const diffTime = processedDate - createdDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays >= 0) {
                        fulfillmentDays.push(diffDays);
                    }
                }
            });
            
            if (fulfillmentDays.length === 0) return 0;
            
            const avgDays = fulfillmentDays.reduce((sum, days) => sum + days, 0) / fulfillmentDays.length;
            return avgDays;
        }

        function openDashboard() {
            log('üöÄ Abriendo dashboard principal...');
            window.open('shopify-analytics-dashboard.html', '_blank');
        }

        function clearConsole() {
            if (consoleElement) {
                consoleElement.textContent = '';
                log('üóëÔ∏è Consola limpiada');
            }
        }
    </script>
</body>
</html>